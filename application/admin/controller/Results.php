<?php
/**
 * Created by PhpStorm.
 * User: 65998
 * Date: 2018/4/28
 * Time: 9:42
 */

namespace app\admin\controller;


use think\Db;
use app\model\Category;
use app\model\Video;

class Results extends Init {
    function initialize() {
        parent::initialize(); // TODO: Change the autogenerated stub
        $Channel = Category::where('parent_id', 0)->select();
        $this->assign('Channel', $Channel);
    }

    //导入操作
    public function _import() {
        $ids = input('post.');
        if (is_array($ids)) {
            foreach ($ids['ids'] as $k=>$v) {
                if (!$v) continue;
                $data = Db::name('result')->find($v);
                unset($data['id']);
                unset($data['page']);
                unset($data['col_id']);
                unset($data['col_name']);
                $res = Video::where([['title','=',$data['title'],['cat_id','=',$data['cat_id']]]])->value('id');
                if($res){
                    unset($ids['ids'][$k]);
                    continue;
                }
                Video::insert($data);
                Db::name('result')->where('id', $v)->update(['status' => 1]);
            }
        }

        if($ids['ids']){
            $data = [
                'username'    => session('admin.username'),
                'table'       => 'result',
                'remark'      => '将ID为[' . implode(',', $ids['ids']) . ']的数据导入到[video]中',
                'action_ip'   => get_client_ip(),
                'action_time' => time(),
            ];
            addSysLog($data);
        }

        $this->success('导入成功');
    }

    //采集记录
    public function index() {
        $title  = input('title');
        $cat_id = input('cat_id/d');
        $id     = input('id');

        $cat_id == true && $where[] = ['cat_id', '=', $cat_id];
        $title == true && $where[] = ['b.title', 'like', "%$title%"];
        $id == true && $where[] = ['col_id', '=', $id];

        $list     = Video::field('id,cat_id,col_name,col_id,title,insert_time,status,tags')->where($where)->order('status asc,update_time desc')->paginate(0, false, ['query' => input()]);
        $category = Category::where('parent_id', 0)->select();

        $this->assign('category', $category);
        $this->assign('id', $id);
        $this->assign('cat_id', $cat_id);
        $this->assign('list', $list);
        $this->assign('i', 0);

        return $this->fetch();
    }


    //资讯修改、添加操作
    function info_save($data) {
        $channel                     = input('channel') ?: 1;
        $data['data']['insert_time'] = time();
        $data['data']['update_time'] = time();
        $data['data']['channel']     = Category::where('id', $channel)->value('alias');
        $data['data']['status']      = 1;

        $data['data']['content'] = clearCss($data['data']['content']);

        //        try {
        if ($data['data']['id']) {
            Db::name('result')->update($data['data']);
        } else {
            $id = Db::name('result')->insertGetId($data['data']);
        }
        /*} catch (\Exception $e) {
            return 0;
        }*/
        return 1;
    }

    //编辑文章
    public function edit() {
        if (isAjax()) {
            $data = input('post.');
            $code = $this->info_save($data);
            $msg  = $code ? '编辑成功' : '编辑失败';
            if ($code) {
                $this->success($msg, input('prevUrl'));
            } else {
                $this->error($msg);
            }
        }
        $info    = Db::name('result')->find(input('id'));
        $channel = input('channel') ?: Category::where('alias', $info['channel'])->value('id');
        $cats    = Category::where([['status', '=', 1], ['parent_id', '=', $channel]])->select();


        $this->assign('cats', $cats);
        $this->assign('prevUrl', prevUrl());
        $this->assign('channel', $channel);
        $this->assign('info', $info);
        return $this->fetch('info');
    }
}